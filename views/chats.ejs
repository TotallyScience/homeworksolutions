<!DOCTYPE html>
<html>
    <head>
        <%- include('includes/head.ejs') %>
        <link rel="stylesheet" href="/styles/chats.css" />
        <script src="https://cdn.socket.io/socket.io-3.0.0.js"></script>
    </head>
    <% if(chatters.length > 0) { %>
    <body>
        <%- include('includes/navbar.ejs') %>
        <div id="chatCon">
            <div class="chats">
                <% chatters.forEach(chatter => {%>
                <div onclick="window.open('/chat?user=<%=chatter._id.toString()%>', '_self')"
                    class="chatter <%if(currentChatter._id.toString() == chatter._id.toString()){%>selected<%}%>"
                >
                    <div>
                        <img
                            src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
                        />
                        <p><%=chatter.username%></p>
                    </div>
                    <hr />
                </div>
                <% });%>
            </div>
            
            <div class="currentChat">
                <div class="infoBar">
                    <img
                        src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
                    />
                    <p><%=currentChatter.username%></p>
                </div>
                <div class="chatView" id="chatView">

                    <% if(chats.length > 0) { %> 
                        <% if(chats.length > 24) { %>
                        <div class="loadMoreCon">
                            <button onclick="loadMore()">Load more messages</button>   
                        </div>
                        <% } %>
                    <% chats.forEach(chat => { %>
                        <%if(chat.message.includes('/SERVER/CLIENTCOMPLETE/')){%>
                            <div class='server'>
                                <p class="name bold">SERVER</p>
                                <p class="message">Order #<%=chat.message.replace("/SERVER/CLIENTCOMPLETE/", "")%> has been marked as complete. Thank you for using Homework Solutions. Please leave a rating for the client...</p>
                            </div>
                        <%} else if (chat.message.includes('/SERVER/CANCELCOMPLETE/')){ %>
                            <div class='server'>
                                <p class="name bold">SERVER</p>
                                <p class="message">Order #<%=chat.message.replace("/SERVER/CANCELCOMPLETE/", "")%> has been marked as incomplete.</p>
                            </div>
                        <%} else if (chat.message.includes('/SERVER/HELPERCOMPLETE/')){ %>
                            <div class='server'>
                                <p class="name bold">SERVER</p>
                                <p class="message">The helper marked Order #<%=chat.message.replace("/SERVER/HELPERCOMPLETE/", "")%> as complete. If you feel the order is not complete, click <a href='/orders/completeOrder/cancel/<%=chat.message.replace("/SERVER/HELPERCOMPLETE/", "")%>' style="color:red" >here</a> to cancel the request. After 48 hours of no response it will automatically be set to complete.</a></p>
                            </div>
                        <%} else if (chat.message.includes('/SERVER/')){ %>
                        <div class='server'>
                            <p class="name bold">SERVER</p>
                            <p class="message">Files for Order #<%=chat.message.replace("/SERVER/", "")%> have been submited and are now downloadable <a href='/orders/downloadfiles/submitted/<%=chat.message.replace("/SERVER/", "")%>'>here.</a></p>
                        </div>
                        <%} else { %>
                        <div <%if(chat.sender == 'You'){%>class='you'<%}%>>
                            <p class="name bold"><%=chat.sender%></p>
                            <p class="message"><%=chat.message%></p>
                        </div>
                    <% } }); } %>
                </div>

                <div class="writeChat">
                    <input type="text"
                    id="sendMessage"
                    placeholder="Write a message..."
                    ></textarea>
                </div>
                    
            </div>
        </div>
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            let chatterid = '<%=currentChatter._id.toString()%>';
            let userid = '<%=userid%>';
            if(chatterid.localeCompare(userid) >= 1)
            {
                var roomid = chatterid+userid;
            }
            else
            {
                var roomid = userid+chatterid;
            }

            var sendMessage = document.getElementById('sendMessage'); // Here your text input element
            sendMessage.addEventListener('keyup', function (event) {
                if (event.keyCode === 13 && !event.shiftKey) {
                    // 13 is the number of Enter key on keyboard
                    if(sendMessage.value != '')
                    {

                        //append message to html
                        appendMessage(true, sendMessage.value);

                        //send webhook
                        console.log("Made");
                        socket.emit('send-message', roomid, sendMessage.value);
                        //update db
                        fetch('/chat/send', {
                        method: 'POST',
                        body: JSON.stringify({
                            recipient:'<%=currentChatter._id%>',
                            message: sendMessage.value
                        }),
                        headers: {
                            'Content-type': 'application/json; charset=UTF-8',
                        }
                        });
                        event.preventDefault();
                        sendMessage.value = '';
                    }
                }
            });

            function appendMessage(youSent, message)
            {   
                const chatsEl = document.getElementById('chatView');
                if(message.includes('/SERVER/CLIENTCOMPLETE/'))
                {
                    message = message.replace("/SERVER/CLIENTCOMPLETE/", "")
                    chatsEl.innerHTML += `
                    <div class='server'>
                        <p class="name bold">SERVER</p>
                        <p class="message">Order #${message} has been marked as complete. Thank you for using Homework Solutions. Please leave a rating for the client...</p>
                    </div>
                    `
                }
                else if(message.includes('/SERVER/CANCELCOMPLETE/'))
                {
                    message = message.replace("/SERVER/CANCELCOMPLETE/", "")
                    chatsEl.innerHTML += `
                    <div class='server'>
                        <p class="name bold">SERVER</p>
                        <p class="message">Order #${message} has been marked as incomplete.</p>
                    </div>
                    `
                }
                else if(message.includes('/SERVER/HELPERCOMPLETE/'))
                {
                    message = message.replace("/SERVER/HELPERCOMPLETE/", "")
                    chatsEl.innerHTML += `
                    <div class='server'>
                        <p class="name bold">SERVER</p>
                        <p class="message">The helper marked Order #${message} as complete. If you feel the order is not complete, click <a href='/orders/completeOrder/cancel/${message}' style="color:red" >here</a> to cancel the request. After 48 hours of no response it will automatically be set to complete.</p>
                    </div>
                    `
                }
                else if(message.includes('/SERVER/'))
                {
                    message = message.replace("/SERVER/", "")
                    chatsEl.innerHTML += `
                    <div class='server'>
                        <p class="name bold">SERVER</p>
                        <p class="message">Files for Order #${message} have been submited and are now downloadable <a href='/orders/downloadfiles/submitted/${message}'>here.</a></p>
                    </div>
                    `
                }   
                else if(youSent)
                {
                    chatsEl.innerHTML += `
                    <div class='you'>
                        <p class="name bold">You</p>
                        <p class="message">${sendMessage.value}</p>
                    </div>
                    `
                }
                else
                {
                    chatsEl.innerHTML += `
                    <div>
                        <p class="name bold"><%=currentChatter.username%></p>
                        <p class="message">${message}</p>
                    </div>
                    `
                }
                scrollToBottom();
            }

            

            function loadMore()
            {
                let limit = 50;
                if (urlParams.get('limitMessages')) {
                    limit = parseInt(urlParams.get('limitMessages'));
                    limit += 25;
                }
                window.open(`/chat?user=${urlParams.get('user')}&limitMessages=${limit}`, '_self');
            }

            function scrollToBottom()
            {
                if(!urlParams.get('limitMessages'))
                {
                    let chatCon = document.getElementById("chatView");
                    chatCon.scrollTop = chatCon.scrollHeight;
                }
            }
            scrollToBottom();

            
            const socket = io();
            socket.io.on("error", (error) => {
                console.log(error);
            })
            

            socket.emit('join-room', roomid);

            socket.on('message', text=> {
                console.log(text);
                appendMessage(false, text);
            })
        </script>
    </body>
    <% } else {%>
        <body>
        <%- include('includes/navbar.ejs') %>
        <div id="chatCon">
            <h1>You have no chats currently.</h1>
        </div>
    </body>
    <% }%>
</html>
